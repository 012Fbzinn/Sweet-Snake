<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Produto • Sweet Snake</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Poppins',sans-serif;background:#0f1724}
    /* --- Popup / Estrelas Styling & Animações --- */
    #feedbackModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      padding: 1rem;
    }
    #feedbackBox {
      width: 100%;
      max-width: 520px;
      background: linear-gradient(145deg,#111827,#1f2937);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      color: #fff;
    }
    .star {
      font-size: 2.25rem;
      color: #555;
      cursor: pointer;
      transition: transform .25s ease, color .25s ease, text-shadow .25s ease;
      display: inline-block;
      animation: idleGlow 2.8s infinite ease-in-out;
      margin: 0 .25rem;
    }
    @keyframes idleGlow {
      0% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 0.85; transform: scale(1.03); }
      100% { opacity: 0.6; transform: scale(1); }
    }
    .star:hover {
      color: #fbbf24;
      transform: scale(1.18);
      text-shadow: 0 0 14px rgba(251,191,36,0.9);
    }
    .star.selected {
      color: #fbbf24 !important;
      text-shadow: 0 0 20px rgba(251,191,36,1);
      animation: clickPop .28s ease-out;
    }
    @keyframes clickPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); }
      100% { transform: scale(1); }
    }
    .feedback-textarea { background:#111827; color:#fff; border:1px solid #2b2f33; border-radius:8px; padding:.6rem; width:100%; }
    .btn-primary { background:#f97316; color:#000; padding:.6rem 1rem; font-weight:600; border-radius:8px; }
    .btn-secondary { background:#374151; color:#fff; padding:.5rem .8rem; border-radius:8px; }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center p-6 bg-gray-900">
  <div class="w-full max-w-4xl bg-gradient-to-b from-gray-800 via-gray-900 to-black rounded-2xl p-6">
    <div id="produto-wrap"></div>
    <div class="mt-6">
      <a href="catalogo.html" class="px-4 py-2 bg-gray-700 text-white rounded-md">Voltar</a>
      <a href="carrinho.html" class="px-4 py-2 bg-orange-500 text-black rounded-md ml-3">Ver Carrinho</a>
    </div>
  </div>

  <!-- FEEDBACK POPUP -->
  <div id="feedbackModal" aria-hidden="true">
    <div id="feedbackBox" role="dialog" aria-modal="true">
      <div class="mb-3 text-center">
        <h3 class="text-xl font-bold">Avalie sua experiência</h3>
        <p class="text-gray-300 text-sm mt-1">Antes de finalizar, diga rapidinho como foi — leva 5 segundos.</p>
      </div>

      <div id="stars" class="flex justify-center mb-3" aria-label="Avaliação por estrelas">
        <span class="star" data-star="1">★</span>
        <span class="star" data-star="2">★</span>
        <span class="star" data-star="3">★</span>
        <span class="star" data-star="4">★</span>
        <span class="star" data-star="5">★</span>
      </div>

      <textarea id="feedbackComment" class="feedback-textarea mb-3" rows="3" placeholder="Comentário opcional (diga algo rápido)"></textarea>

      <div class="flex gap-3">
        <button id="sendFeedbackBtn" class="btn-primary flex-1">Enviar feedback e finalizar</button>
        <button id="cancelFeedbackBtn" class="btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // Seller number
    const vendedor = '11989646392';

    // Produtos
    const produtos = {
      'agendamento': { id: 'agendamento', name: 'Agendamento', price: 'R$4.00', img: 'apito-faixa.jpeg', desc: '' },
      'tortas': { id: 'tortas', name: 'Snake Premium', price: 'R$35.00', img: 'COMPLETO.png', desc: '' },
      'brigadeiros': { id: 'brigadeiros', name: 'Combo Sweet', price: 'R$20.00', img: 'DOCE.png', desc: '' },
      'cones': { id: 'cones', name: 'Duo Perfeito', price: 'R$15.00', img: 'QUENTE.png', desc: '' },
      'bolos': { id: 'bolos', name: 'Cone Tradicional', price: 'R$8.00', img: 'cones.png', desc: '' },
      'especiais': { id: 'especiais', name: 'Cone Oreo', price: 'R$8.00', img: 'Oreo.jpeg', desc: '' },
      'trufas': { id: 'trufas', name: 'Trufa De Maracujá', price: 'R$6.00', img: 'trufas.png', desc: '' },
      'cupcakes': { id: 'cupcakes', name: 'Trufa Tradicional', price: 'R$6.00', img: 'trufaB.jpeg', desc: '' },
      'brownies': { id: 'brownies', name: 'Brownies', price: 'R$14.00', img: 'brownie.png', desc: '' },
      'cookies': { id: 'cookies', name: 'Torta', price: 'R$12.00', img: 'torta.png', desc: '' }
    };

    // popup elements
    const feedbackModal = document.getElementById('feedbackModal');
    const starsEls = document.querySelectorAll('#stars .star');
    const feedbackComment = document.getElementById('feedbackComment');
    const sendFeedbackBtn = document.getElementById('sendFeedbackBtn');
    const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
    let selectedStars = 0;
    let pendingPurchase = null; // {prod, qty} stored when user clicks Comprar

    // star behaviors (hover, out, click)
    starsEls.forEach(s => {
      s.addEventListener('mouseover', () => {
        const v = Number(s.dataset.star);
        for (let i=0;i<starsEls.length;i++){
          if (i < v) { starsEls[i].style.color = '#fbbf24'; starsEls[i].style.transform = 'scale(1.12)'; starsEls[i].style.textShadow = '0 0 12px rgba(251,191,36,0.85)'; }
          else { starsEls[i].style.color = '#555'; starsEls[i].style.transform = 'scale(1)'; starsEls[i].style.textShadow='none'; }
        }
      });
      s.addEventListener('mouseout', () => {
        // reset hover visuals; keep selected stars marked
        for (let i=0;i<starsEls.length;i++){
          if (i < selectedStars) { starsEls[i].classList.add('selected'); starsEls[i].style.color = '#fbbf24'; starsEls[i].style.transform = 'scale(1)'; starsEls[i].style.textShadow='0 0 14px rgba(251,191,36,0.85)'; }
          else { starsEls[i].classList.remove('selected'); starsEls[i].style.color = '#555'; starsEls[i].style.transform = 'scale(1)'; starsEls[i].style.textShadow='none'; }
        }
      });
      s.addEventListener('click', () => {
        selectedStars = Number(s.dataset.star);
        for (let i=0;i<starsEls.length;i++){
          if (i < selectedStars) { starsEls[i].classList.add('selected'); starsEls[i].style.color = '#fbbf24'; }
          else { starsEls[i].classList.remove('selected'); starsEls[i].style.color = '#555'; }
        }
      });
    });

    cancelFeedbackBtn.addEventListener('click', () => {
      // cancel feedback and clear pending
      selectedStars = 0;
      feedbackComment.value = '';
      pendingPurchase = null;
      closeFeedback();
    });

    sendFeedbackBtn.addEventListener('click', () => {
      if (selectedStars === 0) { alert('Por favor, selecione uma nota.'); return; }
      // save feedback locally
      const fbList = JSON.parse(localStorage.getItem('feedbacks') || '[]');
      const fb = {
        stars: selectedStars,
        comment: feedbackComment.value.trim(),
        date: new Date().toLocaleString()
      };
      fbList.push(fb);
      localStorage.setItem('feedbacks', JSON.stringify(fbList));

      // proceed with pending purchase (must exist)
      if (!pendingPurchase) {
        alert('Erro interno: compra pendente não encontrada.');
        closeFeedback();
        return;
      }

      // add to purchases history (with feedback)
      const user = JSON.parse(localStorage.getItem('user_profile') || 'null');
      if (!user) { alert('Você precisa estar logado.'); window.location.href='login.html'; return; }

      const historico = JSON.parse(localStorage.getItem('compras_history') || '[]');
      historico.push({
        nome: user.nome,
        whatsapp: user.whatsapp,
        serie: user.serie,
        produto: pendingPurchase.prod.name,
        quantidade: pendingPurchase.qty,
        valorUnitario: pendingPurchase.prod.price,
        data: new Date().toLocaleString(),
        feedback: fb
      });
      localStorage.setItem('compras_history', JSON.stringify(historico));

      // open whatsapp with purchase message
      const mensagem = `Olá, tenho interesse em *${pendingPurchase.prod.name}* (qtd: ${pendingPurchase.qty}). Meu nome: ${user.nome} - Série: ${user.serie} - WhatsApp: ${user.whatsapp}`;
      const url = `https://wa.me/55${vendedor}?text=${encodeURIComponent(mensagem)}`;

      // clear pending and close modal then redirect
      pendingPurchase = null;
      closeFeedback();
      window.location.href = url;
    });

    function openFeedbackForPurchase(prod, qty){
      selectedStars = 0;
      feedbackComment.value = '';
      // reset star visuals
      starsEls.forEach(s => { s.classList.remove('selected'); s.style.color='#555'; s.style.transform='scale(1)'; s.style.textShadow='none'; });
      pendingPurchase = { prod, qty };
      feedbackModal.style.display = 'flex';
      feedbackModal.setAttribute('aria-hidden', 'false');
    }
    function closeFeedback(){ feedbackModal.style.display='none'; feedbackModal.setAttribute('aria-hidden','true'); }

    // --- Existing product page logic ---
    function getQueryParam(key) {
      const url = new URL(window.location.href);
      return url.searchParams.get(key);
    }

    function addToCart(prod) {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const idx = cart.findIndex(i => i.id === prod.id);
      if (idx >= 0) cart[idx].qty += prod.qty || 1;
      else cart.push({ ...prod, qty: prod.qty || 1 });
      localStorage.setItem('cart', JSON.stringify(cart));
      alert('Adicionado ao carrinho');
    }

    // Registrar compra now just saved in sendFeedback flow above (so keep registrarCompra but avoid double redirect)
    function registrarCompra(prod, qty=1) {
      // kept for compatibility - but we now prefer the modal flow.
      // call openFeedbackForPurchase instead of immediate redirect.
      const user = JSON.parse(localStorage.getItem('user_profile') || 'null');
      if (!user) { alert('Você precisa estar logado para comprar.'); window.location.href = 'login.html'; return; }
      // Open feedback modal, will finalize purchase after feedback
      openFeedbackForPurchase(prod, qty);
    }

    // Render product UI
    const item = getQueryParam('item');
    const prod = produtos[item];
    const wrap = document.getElementById('produto-wrap');

    if (!prod) {
      wrap.innerHTML = `<div class="text-white">Produto não encontrado. <a href="catalogo.html" class="underline">Voltar</a></div>`;
    } else {
      const optionsHTML = item === 'agendamento' ? `
        <div class="flex items-center gap-3 mb-4">
          <label class="text-gray-300">Escolha um item:</label>
          <select id="agendamentoOption" class="px-3 py-2 rounded-md text-black">
            <option value="apito">Apito</option>
            <option value="faixa">Faixa</option>
          </select>
        </div>
      ` : '';

      wrap.innerHTML = `
        <div class="md:flex gap-6">
          <div class="md:w-1/2">
            <img src="${prod.img}" class="w-full rounded-lg" alt="${prod.name}">
          </div>
          <div class="md:w-1/2 text-white">
            <h1 class="text-3xl font-bold mb-2">${prod.name}</h1>
            <div class="text-orange-400 font-semibold mb-4">${prod.price}</div>
            <p class="text-gray-300 mb-4">${prod.desc}</p>
            ${optionsHTML}
            <div class="flex items-center gap-3 mb-4">
              <label class="text-gray-300">Quantidade</label>
              <input id="qty" type="number" value="1" min="1" class="px-3 py-2 rounded-md text-black w-24">
            </div>
            <div class="flex gap-3">
              <button id="addCartBtn" class="px-4 py-2 bg-black/60 text-white rounded-md">Add ao Carrinho</button>
              <button id="buyBtn" class="px-4 py-2 bg-orange-500 text-black rounded-md">Comprar</button>
            </div>
          </div>
        </div>
      `;

      const qtyInput = document.getElementById('qty');
      const addBtn = document.getElementById('addCartBtn');
      const buyBtn = document.getElementById('buyBtn');

      function getSelectedProduct() {
        let selectedProd = { ...prod };
        if(item === 'agendamento') {
          const sel = document.getElementById('agendamentoOption').value;
          selectedProd.id = `agendamento-${sel}`;
          selectedProd.name = `Agendamento - ${sel.charAt(0).toUpperCase()+sel.slice(1)}`;
          selectedProd.qty = Number(qtyInput.value);
        } else {
          selectedProd.qty = Number(qtyInput.value);
        }
        return selectedProd;
      }

      addBtn.addEventListener('click', () => addToCart(getSelectedProduct()));
      buyBtn.addEventListener('click', () => registrarCompra(getSelectedProduct(), Number(qtyInput.value)));
    }
  </script>
</body>
</html>
