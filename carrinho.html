<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carrinho • Sweet Snake</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Poppins',sans-serif;background:#0f1724}

    /* Popup Avaliação */
    #rating-popup {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.7);
      justify-content:center;
      align-items:center;
      z-index:1000;
    }
    #rating-popup .content {
      background:#1f2937;
      padding:2rem;
      border-radius:1rem;
      text-align:center;
      color:white;
      min-width:300px;
    }
    #rating-popup .stars span {
      font-size:2rem;
      cursor:pointer;
      transition: transform 0.2s;
    }
    #rating-popup .stars span:hover { transform: scale(1.3); }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center p-6 bg-gray-900">

<div class="w-full max-w-5xl bg-gradient-to-b from-gray-800 via-gray-900 to-black rounded-2xl p-6">
  <h2 class="text-white text-2xl font-bold mb-4">Carrinho</h2>
  <div id="cart-wrap" class="text-gray-200"></div>

  <div class="mt-6 flex justify-between items-center">
    <div class="text-gray-300" id="total-display">Total: R$0.00</div>
    <div class="flex gap-3">
      <a href="catalogo.html" class="px-4 py-2 bg-gray-700 text-white rounded-md">Continuar comprando</a>
      <button id="buyAllBtn" class="px-4 py-2 bg-orange-500 text-black rounded-md">Comprar Tudo</button>
    </div>
  </div>
</div>

<!-- Popup Avaliação -->
<div id="rating-popup" class="flex">
  <div class="content">
    <h3 class="text-xl mb-4">Avalie sua compra</h3>
    <div class="stars mb-4">
      <span data-value="1">☆</span>
      <span data-value="2">☆</span>
      <span data-value="3">☆</span>
      <span data-value="4">☆</span>
      <span data-value="5">☆</span>
    </div>
    <button id="submitRating" class="px-4 py-2 bg-orange-500 text-black rounded-md">Enviar</button>
  </div>
</div>

<script>
const vendedor = '11989646392',
                 '11950460732',
                 '11952177083',
                 '11989005170',
                 '11978511316';
let rating = 0;

// Carrega carrinho
function loadCart() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const wrap = document.getElementById('cart-wrap');
  wrap.innerHTML = '';
  if (cart.length === 0) {
    wrap.innerHTML = `<div class="text-gray-400">Seu carrinho está vazio.</div>`;
    document.getElementById('total-display').textContent = 'Total: R$0.00';
    return;
  }

  cart.forEach((item, idx) => {
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between bg-gray-800 p-4 rounded-lg mb-3';
    row.innerHTML = `
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 bg-white/5 rounded flex items-center justify-center text-white">${item.name}</div>
        <div>
          <div class="text-white font-semibold">${item.name}</div>
          <div class="text-gray-300">${item.price}</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button class="px-2 py-1 border rounded text-white" onclick="decreaseQty(${idx})">-</button>
        <div class="px-3">${item.qty}</div>
        <button class="px-2 py-1 border rounded text-white" onclick="increaseQty(${idx})">+</button>
        <button class="px-3 py-1 bg-red-600 text-white rounded ml-3" onclick="removeItem(${idx})">Remover</button>
      </div>
    `;
    wrap.appendChild(row);
  });

  updateTotal();
}

function parsePrice(p) { return Number(p.replace('R$', '').replace(',', '.')); }
function formatPrice(n){ return 'R$' + n.toFixed(2); }

function updateTotal() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const total = cart.reduce((s, i) => s + parsePrice(i.price) * i.qty, 0);
  document.getElementById('total-display').textContent = 'Total: ' + formatPrice(total);
}

function increaseQty(i) {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  cart[i].qty += 1;
  localStorage.setItem('cart', JSON.stringify(cart));
  loadCart();
}
function decreaseQty(i) {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  if (cart[i].qty > 1) cart[i].qty -= 1;
  else cart.splice(i,1);
  localStorage.setItem('cart', JSON.stringify(cart));
  loadCart();
}
function removeItem(i) {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  cart.splice(i,1);
  localStorage.setItem('cart', JSON.stringify(cart));
  loadCart();
}

function registrarCompraItem(item, ratingValue=0) {
  const user = JSON.parse(localStorage.getItem('user_profile') || 'null');
  if (!user) { 
    alert('Você precisa estar logado para comprar.'); 
    window.location.href = 'login.html'; 
    return false; 
  }

  const historico = JSON.parse(localStorage.getItem('compras_history') || '[]');
  historico.push({
    nome: user.nome,
    whatsapp: user.whatsapp,
    serie: user.serie,
    produto: item.name,
    quantidade: item.qty,
    valorUnitario: item.price,
    avaliacao: ratingValue,
    data: new Date().toLocaleString()
  });
  localStorage.setItem('compras_history', JSON.stringify(historico));
  return true;
}

// Evento Compra
document.getElementById('buyAllBtn').addEventListener('click', () => {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  if (cart.length === 0) { alert('Carrinho vazio.'); return; }
  const user = JSON.parse(localStorage.getItem('user_profile') || 'null');
  if (!user) { alert('Você precisa estar logado para comprar.'); window.location.href = 'login.html'; return; }

  // Mostrar popup avaliação
  const popup = document.getElementById('rating-popup');
  popup.style.display = 'flex';

  // Seleção estrelas
  document.querySelectorAll('#rating-popup .stars span').forEach(star => {
    star.onclick = () => {
      rating = Number(star.dataset.value);
      document.querySelectorAll('#rating-popup .stars span').forEach(s => {
        s.textContent = s.dataset.value <= rating ? '★' : '☆';
      });
    }
  });

  // Ao enviar avaliação
  document.getElementById('submitRating').onclick = () => {
    popup.style.display = 'none';

    // Registrar cada item com a avaliação
    cart.forEach(item => registrarCompraItem(item, rating));

    alert(`Obrigado pela avaliação de ${rating} estrelas!`);

    // Montar mensagem WhatsApp
    const total = cart.reduce((s,i) => s + parsePrice(i.price) * i.qty, 0);
    let msg = `Olá, tenho interesse nos itens:%0A`;
    cart.forEach(i => msg += `- ${i.name} (qtd: ${i.qty})%0A`);
    msg += `%0ATotal: ${formatPrice(total)}%0A%0AMeu nome: ${user.nome} - Série: ${user.serie} - WhatsApp: ${user.whatsapp}`;

    // Limpar carrinho e redirecionar
    localStorage.removeItem('cart');
    loadCart();
    window.location.href = `https://wa.me/55${vendedor}?text=${msg}`;
  }
});

// Init
loadCart();
</script>

</body>
</html>
